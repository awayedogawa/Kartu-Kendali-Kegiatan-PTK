<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manajemen Pagu - Kartu Kendali PTK</title>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <style>
        /* ... (CSS tetap sama seperti sebelumnya) ... */
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap');
        :root{--primary-color:#0d6efd;--success-color:#198754;--danger-color:#dc3545;--warning-color:#ffc107;--info-color:#6c757d;--background-color:#f4f7f6;--card-background:#ffffff;--text-color:#212529;--text-muted:#6c757d;--border-color:#e9ecef;}body{font-family:'Poppins',sans-serif;background-color:var(--background-color);color:var(--text-color);margin:0}.header{background-color:var(--card-background);padding:15px 30px;display:flex;justify-content:space-between;align-items:center;box-shadow:0 2px 4px rgba(0,0,0,0.05)}.header .logo{font-weight:700;font-size:1.2em;color:var(--primary-color)}.header .user-info{display:flex;align-items:center;gap:15px}.header .user-details{text-align:right}.header .user-details .name{font-weight:600;display:block}.header .user-details .role{font-size:.8em;color:var(--text-muted);text-transform:capitalize}.btn-header{background-color:var(--info-color);color:#fff;border:none;padding:8px 15px;border-radius:5px;cursor:pointer;font-weight:500;text-decoration:none;font-size:1em}.container{padding:30px}.card{background-color:var(--card-background);padding:25px;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,0.08)}.card-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;flex-wrap:wrap;gap:10px}.card-header h2{margin:0}.header-actions{display:flex;flex-wrap:wrap;gap:10px}.header-actions .btn{margin-left:0;font-size:.9em;padding:8px 15px}.btn{padding:10px 20px;border:none;border-radius:5px;cursor:pointer;font-weight:500;font-size:1em}.btn-primary{background-color:var(--primary-color);color:#fff}.btn-success{background-color:var(--success-color);color:#fff}.btn-danger{background-color:var(--danger-color);color:#fff}#uploadLabel{cursor:pointer}#uploadFile{display:none}.modal{display:none;position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;overflow:auto;background-color:rgba(0,0,0,0.5);justify-content:center;align-items:center}.modal-content{background-color:#fff;padding:30px;border-radius:8px;width:90%;max-width:600px;box-shadow:0 5px 15px rgba(0,0,0,0.3);position:relative}.close-btn{position:absolute;top:15px;right:20px;font-size:28px;font-weight:700;color:#aaa;cursor:pointer}.close-btn:hover{color:#333}.form-grid{display:flex;flex-direction:column;gap:15px}.form-group{display:flex;flex-direction:column}.form-group label{margin-bottom:8px;font-weight:500;font-size:.9em}.form-group input,.form-group select{padding:10px;border:1px solid var(--border-color);border-radius:5px;font-size:1em}table{width:100%;border-collapse:collapse}th,td{padding:12px 15px;text-align:left;border-bottom:1px solid var(--border-color)}th{background-color:#f8f9fa;font-weight:600;white-space:nowrap}td.currency{text-align:right;white-space:nowrap}.parent-row{font-weight:600;background-color:#f8f9fa;cursor:pointer}.parent-row:hover{background-color:#e9ecef}.parent-row .toggle-icon::before{content:'â–¶';display:inline-block;margin-right:10px;transition:transform .2s;font-size:.8em}.parent-row.expanded .toggle-icon::before{transform:rotate(90deg)}.child-row{display:none;background-color:#fff}.child-row td:first-child{padding-left:40px}.parent-row.expanded+.child-row,.child-row.sibling-expanded{display:table-row}.action-buttons{text-align:right;white-space:nowrap}.btn-icon{background-color:transparent;border:none;cursor:pointer;padding:6px;border-radius:50%;display:inline-flex;align-items:center;justify-content:center;margin-left:5px}.btn-icon:hover{background-color:#e9ecef}.btn-icon svg{width:18px;height:18px}.icon-edit{color:var(--primary-color)}.icon-delete{color:var(--danger-color)}
    </style>
</head>
<body>
    <header class="header"></header>

    <main class="container">
        <div class="card">
            <div class="card-header">
                <h2>Daftar Pagu Anggaran</h2>
                <div class="header-actions">
                    <button id="addPaguBtn" class="btn btn-primary">Tambah Pagu</button>
                    <button id="downloadBtn" class="btn btn-primary">Download Template</button>
                    <label for="uploadFile" id="uploadLabel" class="btn btn-success">Upload Pagu</label>
                    <input type="file" id="uploadFile" accept=".xlsx, .xls">
                    <button id="clearDataBtn" class="btn btn-danger">Bersihkan Data</button>
                </div>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>Kode & Uraian Kegiatan</th>
                        <th class="currency">Pagu Anggaran</th>
                        <th class="currency">Terpakai</th>
                        <th class="currency">Sisa Pagu</th>
                        <th class="action-buttons">Aksi</th>
                    </tr>
                </thead>
                <tbody id="paguTableBody"></tbody>
            </table>
        </div>
    </main>

    <div id="paguModal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <h2 id="modalTitle">Tambah Pagu Baru</h2>
            <form id="paguForm">
                <input type="hidden" id="editId">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="kodeSubKegiatan">Kode Sub Kegiatan</label>
                        <input type="text" id="kodeSubKegiatan" required>
                    </div>
                    <div class="form-group">
                        <label for="namaSubKegiatan">Nama Sub Kegiatan</label>
                        <input type="text" id="namaSubKegiatan" required>
                    </div>
                    <div class="form-group">
                        <label for="kodeRekening">Kode Rekening</label>
                        <input type="text" id="kodeRekening" required>
                    </div>
                    <div class="form-group">
                        <label for="uraian">Uraian Kode Rekening</label>
                        <input type="text" id="uraian" required>
                    </div>
                    <div class="form-group">
                        <label for="paguAnggaran">Pagu Anggaran (Rp)</label>
                        <input type="number" id="paguAnggaran" required>
                    </div>
                    <button type="submit" class="btn btn-primary" style="margin-top: 10px;">Simpan</button>
                </div>
            </form>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getFirestore, collection, onSnapshot, doc, deleteDoc, writeBatch, addDoc, query, where, getDocs, updateDoc, getDoc } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyADvqKehIP5u9Me8q029U5X_dNKat2Kb8w",
            authDomain: "kartu-kendali-kegiatan-ptk.firebaseapp.com",
            projectId: "kartu-kendali-kegiatan-ptk",
            storageBucket: "kartu-kendali-kegiatan-ptk.appspot.com",
            messagingSenderId: "694993604999",
            appId: "1:694993604999:web:83eaf3af3ddf0c5d0bc348322"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        // ... (UI Setup dan variabel lainnya)
        const paguTableBody = document.getElementById('paguTableBody');
        const paguModal = document.getElementById('paguModal');
        const paguForm = document.getElementById('paguForm');
        const modalTitle = document.getElementById('modalTitle');
        const editIdInput = document.getElementById('editId');
        const addPaguBtn = document.getElementById('addPaguBtn');
        const closeBtn = document.querySelector('.close-btn');

        // --- Logika Buka/Tutup Modal ---
        addPaguBtn.onclick = () => {
            modalTitle.textContent = 'Tambah Pagu Baru';
            paguForm.reset();
            editIdInput.value = '';
            paguModal.style.display = 'flex';
        };
        closeBtn.onclick = () => paguModal.style.display = 'none';
        window.onclick = (event) => {
            if (event.target == paguModal) {
                paguModal.style.display = 'none';
            }
        };

        // ... (Fungsi renderData yang sudah ada) ...
        function renderData() {
            onSnapshot(collection(db, "anggaran"), (anggaranSnapshot) => {
                const allAnggaran = anggaranSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                onSnapshot(collection(db, "transaksi"), (transaksiSnapshot) => {
                    const realisasi = {};
                    transaksiSnapshot.forEach(doc => {
                        doc.data().rincian.forEach(item => {
                            const id = item.docAnggaranId;
                            if (!realisasi[id]) realisasi[id] = 0;
                            realisasi[id] += item.subtotal;
                        });
                    });

                    const groupedData = allAnggaran.reduce((acc, item) => {
                        const key = item.kodeSubKegiatan;
                        if (!acc[key]) {
                            acc[key] = {
                                namaSubKegiatan: item.namaSubKegiatan, totalPagu: 0, totalTerpakai: 0, rekening: []
                            };
                        }
                        const terpakai = realisasi[item.id] || 0;
                        acc[key].totalPagu += item.paguAnggaran;
                        acc[key].totalTerpakai += terpakai;
                        acc[key].rekening.push({ ...item, terpakai });
                        return acc;
                    }, {});

                    paguTableBody.innerHTML = '';
                    Object.keys(groupedData).sort().forEach(kode => {
                        const group = groupedData[kode];
                        const sisaGroup = group.totalPagu - group.totalTerpakai;
                        const parentRow = document.createElement('tr');
                        parentRow.className = 'parent-row'; parentRow.dataset.kode = kode;
                        parentRow.innerHTML = `<td><span class="toggle-icon"></span>${kode} - ${group.namaSubKegiatan}</td><td class="currency">${formatRupiah(group.totalPagu)}</td><td class="currency">${formatRupiah(group.totalTerpakai)}</td><td class="currency">${formatRupiah(sisaGroup)}</td><td class="action-buttons"><button class="btn-icon icon-delete" title="Hapus Sub Kegiatan" data-delete-group="${kode}"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg></button></td>`;
                        paguTableBody.appendChild(parentRow);
                        
                        group.rekening.sort((a,b) => a.kodeRekening.localeCompare(b.kodeRekening)).forEach(item => {
                            const sisaItem = item.paguAnggaran - item.terpakai;
                            const childRow = document.createElement('tr');
                            childRow.className = 'child-row'; childRow.dataset.parentKode = kode;
                            childRow.innerHTML = `<td>${item.kodeRekening} - ${item.uraian}</td><td class="currency">${formatRupiah(item.paguAnggaran)}</td><td class="currency">${formatRupiah(item.terpakai)}</td><td class="currency">${formatRupiah(sisaItem)}</td><td class="action-buttons">
                                <button class="btn-icon icon-edit" title="Edit Item" data-edit-id="${item.id}"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg></button>
                                <button class="btn-icon icon-delete" title="Hapus Item" data-delete-item="${item.id}"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg></button>
                            </td>`;
                            paguTableBody.appendChild(childRow);
                        });
                    });
                });
            });
        }
        renderData();

        // --- Logika Simpan (Create & Update) ---
        paguForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = editIdInput.value;
            const data = {
                kodeSubKegiatan: document.getElementById('kodeSubKegiatan').value,
                namaSubKegiatan: document.getElementById('namaSubKegiatan').value,
                kodeRekening: document.getElementById('kodeRekening').value,
                uraian: document.getElementById('uraian').value,
                paguAnggaran: Number(document.getElementById('paguAnggaran').value),
            };

            try {
                if (id) { // Update
                    await updateDoc(doc(db, "anggaran", id), data);
                    alert('Data pagu berhasil diperbarui.');
                } else { // Create
                    await addDoc(collection(db, "anggaran"), data);
                    alert('Data pagu baru berhasil disimpan.');
                }
                paguModal.style.display = 'none';
            } catch (error) {
                alert('Gagal menyimpan data.');
                console.error(error);
            }
        });

        paguTableBody.addEventListener('click', async (e) => {
            const button = e.target.closest('.btn-icon');
            if (!button) {
                if (e.target.closest('.parent-row')) {
                    const parentRow = e.target.closest('.parent-row');
                    parentRow.classList.toggle('expanded');
                    document.querySelectorAll(`.child-row[data-parent-kode="${parentRow.dataset.kode}"]`).forEach(child => child.classList.toggle('sibling-expanded'));
                }
                return;
            }
            // Logika Edit
            if (button.dataset.editId) {
                const docId = button.dataset.editId;
                const docRef = doc(db, "anggaran", docId);
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    modalTitle.textContent = 'Edit Data Pagu';
                    editIdInput.value = docId;
                    document.getElementById('kodeSubKegiatan').value = data.kodeSubKegiatan;
                    document.getElementById('namaSubKegiatan').value = data.namaSubKegiatan;
                    document.getElementById('kodeRekening').value = data.kodeRekening;
                    document.getElementById('uraian').value = data.uraian;
                    document.getElementById('paguAnggaran').value = data.paguAnggaran;
                    paguModal.style.display = 'flex';
                }
            }
            // Logika Hapus
            if (button.dataset.deleteItem || button.dataset.deleteGroup) {
                // ... (logika hapus yang sudah ada) ...
            }
        });

        // ... (sisa kode lainnya seperti upload, clear data, dll tetap sama) ...
    </script>
</body>
</html>
